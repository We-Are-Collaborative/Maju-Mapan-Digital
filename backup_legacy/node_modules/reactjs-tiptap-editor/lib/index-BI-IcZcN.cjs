"use strict";const _=require("./index-ByRfqzMr.cjs");function L(D){var a;const{char:E,allowSpaces:M,allowToIncludeChar:I,allowedPrefixes:g,startOfLine:k,$position:f}=D,R=M&&!I,v=_.escapeForRegEx(E),A=new RegExp(`\\s${v}$`),P=k?"^":"",B=I?"":v,y=R?new RegExp(`${P}${v}.*?(?=\\s${B}|$)`,"gm"):new RegExp(`${P}(?:^)?${v}[^\\s${B}]*`,"gm"),p=((a=f.nodeBefore)===null||a===void 0?void 0:a.isText)&&f.nodeBefore.text;if(!p)return null;const K=f.pos-p.length,n=Array.from(p.matchAll(y)).pop();if(!n||n.input===void 0||n.index===void 0)return null;const e=n.input.slice(Math.max(0,n.index-1),n.index),h=new RegExp(`^[${g==null?void 0:g.join("")}\0]?$`).test(e);if(g!==null&&!h)return null;const o=K+n.index;let i=o+n[0].length;return R&&A.test(p.slice(i-1,i+1))&&(n[0]+=" ",i+=1),o<f.pos&&i>=f.pos?{range:{from:o,to:i},query:n[0].slice(E.length),text:n[0]}:null}const z=new _.PluginKey("suggestion");function G({pluginKey:D=z,editor:a,char:E="@",allowSpaces:M=!1,allowToIncludeChar:I=!1,allowedPrefixes:g=[" "],startOfLine:k=!1,decorationTag:f="span",decorationClass:R="suggestion",decorationContent:v="",decorationEmptyClass:A="is-empty",command:P=()=>null,items:B=()=>[],render:y=()=>({}),allow:p=()=>!0,findSuggestionMatch:K=L}){let n;const e=y==null?void 0:y(),h=new _.Plugin({key:D,view(){return{update:async(o,i)=>{var s,r,c,u,d,S,m;const t=(s=this.key)===null||s===void 0?void 0:s.getState(i),l=(r=this.key)===null||r===void 0?void 0:r.getState(o.state),$=t.active&&l.active&&t.range.from!==l.range.from,F=!t.active&&l.active,O=t.active&&!l.active,N=!F&&!O&&t.query!==l.query,q=F||$&&N,C=N||$,b=O||$&&N;if(!q&&!C&&!b)return;const x=b&&!q?t:l,T=o.dom.querySelector(`[data-decoration-id="${x.decorationId}"]`);n={editor:a,range:x.range,query:x.query,text:x.text,items:[],command:w=>P({editor:a,range:x.range,props:w}),decorationNode:T,clientRect:T?()=>{var w;const{decorationId:U}=(w=this.key)===null||w===void 0?void 0:w.getState(a.state),j=o.dom.querySelector(`[data-decoration-id="${U}"]`);return(j==null?void 0:j.getBoundingClientRect())||null}:null},q&&((c=e==null?void 0:e.onBeforeStart)===null||c===void 0||c.call(e,n)),C&&((u=e==null?void 0:e.onBeforeUpdate)===null||u===void 0||u.call(e,n)),(C||q)&&(n.items=await B({editor:a,query:x.query})),b&&((d=e==null?void 0:e.onExit)===null||d===void 0||d.call(e,n)),C&&((S=e==null?void 0:e.onUpdate)===null||S===void 0||S.call(e,n)),q&&((m=e==null?void 0:e.onStart)===null||m===void 0||m.call(e,n))},destroy:()=>{var o;n&&((o=e==null?void 0:e.onExit)===null||o===void 0||o.call(e,n))}}},state:{init(){return{active:!1,range:{from:0,to:0},query:null,text:null,composing:!1}},apply(o,i,s,r){const{isEditable:c}=a,{composing:u}=a.view,{selection:d}=o,{empty:S,from:m}=d,t={...i};if(t.composing=u,c&&(S||a.view.composing)){(m<i.range.from||m>i.range.to)&&!u&&!i.composing&&(t.active=!1);const l=K({char:E,allowSpaces:M,allowToIncludeChar:I,allowedPrefixes:g,startOfLine:k,$position:d.$from}),$=`id_${Math.floor(Math.random()*4294967295)}`;l&&p({editor:a,state:r,range:l.range,isActive:i.active})?(t.active=!0,t.decorationId=i.decorationId?i.decorationId:$,t.range=l.range,t.query=l.query,t.text=l.text):t.active=!1}else t.active=!1;return t.active||(t.decorationId=null,t.range={from:0,to:0},t.query=null,t.text=null),t}},props:{handleKeyDown(o,i){var s;const{active:r,range:c}=h.getState(o.state);return r&&((s=e==null?void 0:e.onKeyDown)===null||s===void 0?void 0:s.call(e,{view:o,event:i,range:c}))||!1},decorations(o){const{active:i,range:s,decorationId:r,query:c}=h.getState(o);if(!i)return null;const u=!(c!=null&&c.length),d=[R];return u&&d.push(A),_.DecorationSet.create(o.doc,[_.Decoration.inline(s.from,s.to,{nodeName:f,class:d.join(" "),"data-decoration-id":r,"data-decoration-content":v})])}}});return h}exports.Suggestion=G;
