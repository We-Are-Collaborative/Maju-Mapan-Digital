/*
 *             Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{global as _0x54f38a,ObservableMixin as _0x379aef}from'ckeditor5/src/utils.js';import{DialogViewPosition as _0x57f573}from'ckeditor5/src/ui.js';import{IconUploadcareImageEdit as _0x4b1763}from'ckeditor5/src/icons.js';import _0x17efa8 from'./uploadcareimageeditformview.js';import _0x402e55 from'../../utils/uploadutils.js';import{getImageUrls as _0x54cd26,getImageDimension as _0x5ee1fe}from'../../utils/editingutils.js';import{isAncestor as _0x37d51a}from'../../utils/isancestor.js';export default class z extends/* #__PURE__ -- @preserve */
_0x379aef(){['_editor'];['_dialog'];['_imageElement'];['_imageCache'];['_controller'];['_attributes'];constructor(_0x57a26d,_0x43690e,_0x3107e3){super(),this['_editor']=_0x57a26d,this['_dialog']=_0x43690e,this['_imageElement']=_0x3107e3,this['_imageCache']=this['_editor']['plugins']['get']('UploadcareImageEditUI')['imageCache'],this['_attributes']=this['_editor']['config']['get']('uploadcare.editor')||{},this['set']({'isActive':!0x0,'imageStatus':'ready','imageErrorType':null,'imageId':null,'imageSrc':null,'imageDimension':null,'imageUploadProgress':null}),this['_prepareImage'](),this['_showDialog']();}['destroy'](){this['isActive']=!0x1,this['stopListening'](),this['stopDelegating'](),'uploading'===this['imageStatus']&&this['_controller']&&this['_controller']['abort']();}async['_prepareImage'](){const _0x1f6cea=this['_imageElement'],_0x301936=_0x1f6cea['getAttribute']('uploadcareImageId'),_0x17e063=_0x1f6cea['getAttribute']('src');if(_0x301936)await this['_loadImageInfo'](_0x301936,_0x17e063);else{if(this['_imageCache']['has'](_0x17e063)){const _0x220eee=this['_imageCache']['get'](_0x17e063);this['imageStatus']='ready',this['imageErrorType']=null,this['imageSrc']=_0x220eee['url'],this['imageDimension']=_0x220eee['dimension'],this['imageId']=_0x220eee['id'];}else this['imageStatus']='uploading',this['imageUploadProgress']=0x0,this['_controller']=new AbortController(),await this['_uploadImage'](this['_imageElement'],this['_controller']);}}['_showDialog'](){const {locale:_0x636a41}=this['_editor'],t=_0x636a41['t'],_0x162ae1=new _0x17efa8(_0x636a41,this['imageStatus'],this['_attributes']);_0x162ae1['bind']('status')['to'](this,'imageStatus'),_0x162ae1['_loadingView']['bind']('imageUploadProgress')['to'](this,'imageUploadProgress'),_0x162ae1['_editingView']['bind']('imageSrc')['to'](this,'imageSrc'),_0x162ae1['_errorView']['bind']('errorType')['to'](this,'imageErrorType'),this['_addEditViewListeners'](_0x162ae1,this['_imageElement']),this['_dialog']['show']({'id':'uploadcareImageEdit','icon':_0x4b1763,'title':t({'id':'Edit\x20Image\x20(Uploadcare)','string':'Edit\x20image'}),'content':_0x162ae1,'position':_0x57f573['EDITOR_TOP_CENTER'],'isModal':!0x0,'onShow':()=>{_0x162ae1['focus']();},'onHide':()=>{_0x162ae1['destroy'](),this['destroy']();},'keystrokeHandlerOptions':{'filter':_0x145689=>!_0x37d51a(_0x145689,_0x162ae1['element'])}});}['_loadImageInfo'](_0x1a09c7,_0x3d7e1c){return _0x402e55['getInfo'](_0x1a09c7,{'publicKey':this['_editor']['config']['get']('uploadcare.pubkey')})['then'](_0x114390=>{const {width:_0x56010a,height:_0x3848f4}=_0x114390['imageInfo'];this['imageStatus']='ready',this['imageErrorType']=null,this['imageSrc']=_0x3d7e1c,this['imageDimension']={'width':_0x56010a,'height':_0x3848f4},this['imageId']=_0x1a09c7;})['catch'](_0x28bfaf=>{this['imageStatus']='error',this['imageErrorType']='FileNotFoundError'===_0x28bfaf['code']?'NotFound':'Network',this['imageSrc']=null,this['imageDimension']=null,this['imageId']=null,this['imageUploadProgress']=null;});}['_uploadImage'](_0x4e4564,_0xe2ba3e){return this['_getImageAsFile'](_0x4e4564)['then'](_0x27785a=>_0x402e55['upload']({'publicKey':this['_editor']['config']['get']('uploadcare.pubkey'),'signal':_0xe2ba3e['signal'],'file':_0x27785a,'onProgress':_0x1dc3ac=>{_0x1dc3ac&&_0x1dc3ac['isComputable']&&(this['imageUploadProgress']=Math['ceil'](0x64*_0x1dc3ac['value']));}}))['then'](_0x92e6e6=>{const {width:_0x26e576,height:_0x5eea1c}=_0x92e6e6['imageInfo'];this['imageStatus']='ready',this['imageErrorType']=null,this['imageSrc']=_0x92e6e6['cdnUrl'],this['imageDimension']={'width':_0x26e576,'height':_0x5eea1c},this['imageId']=_0x92e6e6['uuid'],this['imageUploadProgress']=null;const _0x369445=_0x4e4564['getAttribute']('src');this['_imageCache']['set'](_0x369445,{'id':_0x92e6e6['uuid'],'url':_0x92e6e6['cdnUrl'],'dimension':this['imageDimension']});})['catch'](_0x5dc3d4=>{this['imageStatus']='error',this['imageErrorType']='FileNotFoundError'===_0x5dc3d4['code']?'NotFound':'Network',this['imageSrc']=null,this['imageDimension']=null,this['imageId']=null,this['imageUploadProgress']=null;});}['_addEditViewListeners'](_0x1226c1,_0x2dc6a1){_0x1226c1['on']('apply',(_0x501d68,_0x48eb4d)=>{this['_replaceImage'](_0x2dc6a1,_0x48eb4d['imageSrc'],this['imageId']),this['_dialog']['hide']();}),_0x1226c1['on']('retry',()=>{this['imageStatus']='uploading',this['imageUploadProgress']=0x0,this['_controller']=new AbortController(),this['_uploadImage'](this['_imageElement'],this['_controller']);}),_0x1226c1['on']('cancel',()=>{this['_dialog']['hide']();});}['_replaceImage'](_0x454d7d,_0x48f408,_0x2fb774){const _0x380d1d=this['_editor'],{width:_0x79b451,height:_0x28dc87}=_0x5ee1fe(_0x48f408,this['imageDimension']['width'],this['imageDimension']['height']),{imageFallbackUrl:_0x2b92e4,imageSources:_0x20b02b}=_0x54cd26(_0x48f408,_0x79b451);_0x380d1d['model']['change'](_0xd5fc3e=>{if('$graveyard'===_0x454d7d['root']['rootName']){_0x380d1d['execute']('insertImage',{'imageType':_0x454d7d['is']('element','imageInline')?'imageInline':null,'source':{...Object['fromEntries'](_0x454d7d['getAttributes']()),'uploadcareImageId':_0x2fb774,'src':_0x2b92e4,'sources':_0x20b02b,'width':_0x79b451,'height':_0x28dc87}});const _0x32dca5=_0x454d7d['getChildren']();_0x454d7d=_0x380d1d['model']['document']['selection']['getSelectedElement']();for(const _0x3370fa of _0x32dca5)_0xd5fc3e['append'](_0xd5fc3e['cloneElement'](_0x3370fa),_0x454d7d);}else _0xd5fc3e['setSelection'](_0x454d7d,'on'),_0x380d1d['execute']('uploadcareImageReplace',{...Object['fromEntries'](_0x454d7d['getAttributes']()),'uploadcareImageId':_0x2fb774,'src':_0x2b92e4,'sources':_0x20b02b,'width':_0x79b451,'height':_0x28dc87},_0x454d7d);_0xd5fc3e['setSelection'](_0x454d7d,'on');});}async['_getImageAsFile'](_0x308302){const _0x50c5e0=_0x54f38a['window'],_0x1e4f95=_0x54f38a['document']['location']['href'],_0x9da8a7=new _0x50c5e0['URL'](_0x308302['getAttribute']('src'),_0x1e4f95);if('data:'===_0x9da8a7['protocol']){const _0x1e0233=_0x9da8a7['href']['split'](','),_0x630620=_0x1e0233[0x0]['match'](/:(.*?);/)[0x1],_0x48008e=_0x630620['split']('/')[0x1],_0x18ff48=_0x50c5e0['atob'](_0x1e0233[_0x1e0233['length']-0x1]);let _0x45653f=_0x18ff48['length'];const _0x406e4f=new _0x50c5e0['Uint8Array'](_0x45653f);for(;_0x45653f--;)_0x406e4f[_0x45653f]=_0x18ff48['charCodeAt'](_0x45653f);return new _0x50c5e0['File']([_0x406e4f],'image.'+_0x48008e,{'type':_0x630620});}const _0x58ac33=_0x9da8a7['href']['split']('/'),_0x223cad=_0x58ac33[_0x58ac33['length']-0x1],_0x1bac00=_0x223cad['split']('.')[0x1];return _0x50c5e0['fetch'](_0x9da8a7['href'])['then'](_0x4407c1=>_0x4407c1['clone']()['blob']())['then'](_0x5cc8ad=>new _0x50c5e0['File']([_0x5cc8ad],_0x223cad,{'type':'image/'+_0x1bac00}));}}