/*
 *             Copyright (c) 2003-2025, CKSource Holding sp. z o.o. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import{Collection}from'ckeditor5/src/utils.js';import _0x5e8912 from'./../users/user.js';import _0x1cca0c from'./../websocketgateway/websocketgateway.js';import _0x37a37d from'./responses/sessionsconnectresponse.js';import _0x2dbe6d from'./messages/sessionsconnectmessage.js';import _0x3f1914 from'./messages/socketconnectmessage.js';import _0x234c66 from'./messages/socketdisconnectmessage.js';import _0x2de846 from'./../messagescompressor.js';export const _SERVICE=0x3;export default class extends Collection{['_id'];['_sessionType'];['_handlers']=new Map();['_channel'];['_wsGateway'];['_connected'];['_eventsQueue']=[];['_isRunning']=!0x1;constructor(_0x38b463,_0x222f8b){super({'idProperty':'id'}),this['_id']=_0x38b463,this['_sessionType']=_0x222f8b;}async['connect'](_0x14f54b){this['_wsGateway']=_0x14f54b,this['stopListening'](_0x14f54b,'change:state');const _0xd17e76=new _0x2dbe6d(this['_id'],this['_sessionType']);let _0x56783e;try{const _0x370ad9=await this['_wsGateway']['_sendRequest'](0x3,_0x2dbe6d['TYPE'],_0x2de846['encode'](_0xd17e76));_0x56783e=_0x2de846['decode'](_0x370ad9,_0x37a37d);}catch(_0x4bf653){_0x56783e=new _0x37a37d(this['_id'],[]);}this['_connectToChannel'](this['_wsGateway'],_0x56783e['channel'],this['_sessionType']);const _0x2c4800=await async function(_0x42bf5c,_0x1d3bd3){const _0x34a98b=_0x1d3bd3['map'](_0x202430=>_0x202430['userId']),_0x596bae=_0x34a98b['length']?await _0x5e8912['getMany'](_0x42bf5c,_0x34a98b):[];return _0x1d3bd3['map'](_0x3da40a=>{const _0x34d588={'id':_0x3da40a['id'],'role':_0x3da40a['role'],'permissions':_0x3da40a['permissions']};return _0x34d588['user']=_0x3da40a['userId']&&_0x596bae['find'](_0x2bd1d0=>_0x2bd1d0['id']===_0x3da40a['userId'])||new _0x5e8912(),_0x34d588;});}(this['_wsGateway'],_0x56783e['sockets']);for(const _0x4d3bf1 of _0x2c4800)super['add'](_0x4d3bf1);this['_connected']=!0x0,this['fire']('connected'),this['listenTo'](this['_wsGateway'],'change:state',(_0x5e8c69,_0x56e9cc,_0x2e0ada)=>this['_onWsGatewayStateChange'](_0x2e0ada),{'priority':_0x1cca0c['_CHANGE_STATE_EVENT_PRIORITY']}),await this['_runQueue']();}['disconnect'](_0x994dc7=!0x0){if(this['_connected']){for(this['_connected']=!0x1,this['_eventsQueue']=[];this['length'];)super['remove'](0x0);this['_channel']&&(this['stopListening'](this['_channel']),this['_channel']=void 0x0),this['_wsGateway']&&_0x994dc7&&(this['stopListening'](this['_wsGateway']),this['_wsGateway']=void 0x0),this['fire']('disconnected'),_0x994dc7&&this['stopListening']();}}['add'](_0x5d5402,_0x110e8c){throw new TypeError('The\x20collection\x20is\x20read-only.');}['remove'](_0x376f3a){throw new TypeError('The\x20collection\x20is\x20read-only.');}['_connectToChannel'](_0x548fb1,_0x5976f8,_0x29f367){this['_channel']=_0x548fb1['_getChannel'](_0x29f367,_0x5976f8),this['_channel']&&(this['_addHandler'](this['_channel'],_0x3f1914['TYPE'],async _0x2a53fd=>{const _0x555803=_0x2de846['decode'](_0x2a53fd,_0x3f1914);if(-0x1===this['getIndex'](_0x555803['id'])){const _0x474b7f={'id':_0x555803['id'],'role':_0x555803['role'],'permissions':_0x555803['permissions']};_0x555803['userId']&&(_0x474b7f['user']=await _0x5e8912['get'](_0x548fb1,_0x555803['userId'])),super['add'](_0x474b7f);}}),this['_addHandler'](this['_channel'],_0x234c66['TYPE'],_0x25ef9f=>{const _0x4157b2=_0x2de846['decode'](_0x25ef9f,_0x234c66);-0x1!==this['getIndex'](_0x4157b2['id'])&&super['remove'](_0x4157b2['id']);}));}async['_onWsGatewayStateChange'](_0x4ba014){_0x4ba014===_0x1cca0c['STATE_DISCONNECTED']&&this['disconnect'](!0x1),_0x4ba014===_0x1cca0c['STATE_CONNECTED']&&await this['connect'](this['_wsGateway']);}async['_runQueue'](){if(this['_isRunning']||!this['_connected'])return;let _0x3b36a5;for(this['_isRunning']=!0x0;_0x3b36a5=this['_eventsQueue']['shift']();){const _0x3ebe52=this['_handlers']['get'](_0x3b36a5['eventName']);_0x3ebe52&&await _0x3ebe52(_0x3b36a5['data']);}this['_isRunning']=!0x1;}['_addHandler'](_0x4a7e16,_0x5268ab,_0x636e7b){const _0x137416=_0x4a7e16['getEventName'](_0x5268ab,!0x0);this['listenTo'](_0x4a7e16,_0x137416,async(_0x1081e4,_0x2e378f)=>{const _0x4daed8=_0x1081e4['name'];this['_eventsQueue']['push']({'eventName':_0x4daed8,'data':_0x2e378f}),await this['_runQueue']();}),this['_handlers']['set'](_0x137416,_0x636e7b);}}